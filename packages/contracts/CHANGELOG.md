# Changelog

### Unreleased

- Break shared utils for Wallet and BalanceManager into `NocturneUtils` test lib
- Add separate `BalanceManager` unit tests (`BalanceManager.t.sol`)
- Move designated test contracts into `test/harnesses` folder
- Granularize in-contract gas estimate by separating joinsplit cost into verification + handling in `Types.sol`
- Add script for producing `.storage-layouts` file + commit `.storage-layouts` file
- Add storage GAP to `NocturneReentrancyGuard`
- Remove `poseidonTest` from `Wallet.t.sol`
- Delete old `gasTesting` files
- Move the Simple ERC tokens to `test`
- Rename `libs/types.sol` to uppercase `Types.sol`
- Rename:
  - `NoteTransmission` -> `EncryptedNote`
  - `NocturneAddress` -> `StealthAddress`
  - `JoinSplit` event -> `JoinSplitProcessed` event
  - `Refund` event -> `RefundProcessed` event
  - `JoinSplitTx` -> `JoinSplit`
- Remove `deployer` directory in favor of `deploy` package
- Deploy script takes mock subtree update verifier param as env var
- Deploy script logs network info and start block
- Check if bundler payout > 0 tokens and only call transfer if so
- fix loop index bug in `extractJoinSplitProofsAndPis`
- fix contract calculating opDigest differently from frontend
- put forge deps install script into this package
- Add additional unit tests for processing multiple joinsplits
- Make underscores consistent in `WalletUtils` and `AssetUtils`
- Optimizer runs 99999 -> 500 to get back under code size limit
- Modify `hardhat.config.ts` to take private keys from env for deploy script
- Add deploy script to `deployer` directory
- Replace all dependent OZ libraries with their upgradeable versions for Wallet, BalanceManager, CommitmentTreeManager, and NocturneReetrancyGuard
- Replace all constructors for initializers (in Wallet, BalanceManager, CommitmentTreeManager, and NocturneReentrancyGuard)
- Add TransparentProxy, ProxyAdmin, and Versioned to `contracts/upgrade`
- Changed to a custom implementation of ReentrancyGuard to properly reflect operation processing status
- Fixed a bug that `_receivedAssets` is modified outside an operation
- Fixed a bug that refunds in `encodedRefundAssets` are not processed
- Merge `joinSplitTx.encodedAssetAddr` and `joinSplitTx.encodedAssetId` into one `joinSplitTx.encodedAsset`
- Make `performOperation` nonReentrant
- Remove unnecessary `_nonce` state variable, use current tree size as nonce
- Remove `opSuccess` and add `opProcessed`, which indicate internal error during processing
- Fix asset/id encoding according to design doc
- Overhaul BalanceManager logic to use less storage
- Implement gas fee mechanism
- add test for subtree update PI calculation
- separate subtree update PI calculation into separate function
- Make solidity var underscore style consistent
- Add `ProcessOperation` event to wallet to emit details about processed ops
- `Wallet._makeExternalCall` no longer reverts on reverting contract call (enables us to process calls even if they revert)
- Calculate `operationDigest` in wallet instead of pushing `uint256` conversion and mod to `CommitmentTreeManager`
- Use the batch verifier to batch verify all joinsplit proofs in a bundle
- Change verifier interfaces to take structs instead of `uint256` arrays
- Add a `SubtreeUpdate` event to `CommitmentTreeManager` for when a subtree update is committed
- Add `test:gas-report` command
- Add batch proof verification
- Add a `SubtreeUpdate` event to `CommitmentTreeManager` for when a subtree update is committed
- Add `test:gas-report` command
- Migrate for joinsplit
  - Compute operationDigest once for the entire operation
- Rename all "flax" instances to "nocturne"
- Change package version to `-alpha`
- Rename `Joinsplit` to `JoinSplit`
- move `OffchainMerkleTree` into a library and have `CommitmentTreeManager` hold the state
- remove `IBatchMerkle` and `BatchBinaryMerkle`
- split `Utils` into `TreeUtils` and `Utils`
- Add fixture unit test for `SubtreeUpdateVerifier`
- Update `DummyWallet` unit test to use `OffchainMerkleTree` instead
- Add unit test for `OffchainMerkleTree`
- Add `TreeTest` lib to test utils. Containins helpers for computing / maintaining subtree roots
- Add `TestSubtreeUpdateVerifier` to test utils
- Change `CommitmentTreeManager` to use `OffchainMerkleTree` instead of `BatchBinaryMerkle`
- Remove Poseidon from all contracts
- Split `LeavesInserted` event into `InsertNoteCommitment` and `InsertNote`
- Add `IOffChainMerkleTree` and `MerkleTree` for Offchain ZK updates
- Add `Utils` lib for encoding / hashing details
- Add `SubtreeUpdateVerifier` contract
- Make Pairing library from circom reusable for different circuits
- Fix events to have fields > 32 bytes be not `indexed`
- Add `Spend` event and emit on `handleSpend`
- Rename spend transaction `value` to `valueToSpend`
- Fix merkle index bug where `insert8` and `insert16` only incremented `numberOfLeaves` by 1
- Start test suite for `PoseidonBatchBinaryMerkle`
- Break up `BatchBinaryMerkle` lib into `BinaryMerkle` and `Queue`
- Add `Refund` events to `CommitmentTreeManager`
- Update `Spend2Verifier` to match simplified `NocturneAddress` + vk/sk scheme
- Rename `SpendTransaction.noteCommitment` to `newNoteCommitment` for clarity
- Add tests for verifier contract
- Make commitment tree and hash functions generic behind interfaces
- Add contracts as package in yarn workspace
