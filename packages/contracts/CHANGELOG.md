# Changelog

### Unreleased

- add some extra parse utils used when debugging invariant tests
- whitelist erc721/1155 in invariant tests and ensure all assets are actually being received by teller from swapper
- deposit invariant tests add special case workaround for retrieved gas comp == gas comp cap (see inline commment)
- AssetUtils `transferAssetTo` uses `erc721.safeTransferFrom`
- AssetUtils `balanceOfAsset` avoids revert when checking erc721 `ownerOf`
- unit and invariant tests now use `vm.txGasPrice` and test screener comp with non-zero comp amounts
- rename `DepositSumSet` to `ActorSumSet`
- fix comment on guarantees around screener compensation
- ensure deposited and refunded assets are in allowlist and add corresponding unit tests
- make protocol allowlist only address, remove function selector specificity
- update invariant tests to use multideposit for erc20s and eth
- add unit tests for multidepositing 10 deposits
- add unit tests for failure cases of exceeding global cap, using unsupported asset, and depositing over max single deposit size
- `completeDeposit` becomes internal method and we expose `completeErc20Deposit` which checks global hourly cap
- replace `instantiateDeposit` and `instantiateETHDeposit` with erc20-specific methods that allow for multi deposits in same call
- add modifiers to enforce erc20 max deposit size for instantiating deposits and global cap for completing deposits
- add erc20 caps to deposit manager which includes global hourly cap and max deposit size
- use single `_nonce` for deposit manager instead of nonce mapping (cheaper)
- Add `sum` method to `Utils`
- fix `AssetUtils` to ensure erc721 methods only have `value = 1` to avoid any unexpected behavior
- make commitment tree quaternary:
  - update `TreeUtils` constants
  - update `TreeUtils` PI encoding / decoding helpers
  - update joinsplit and subtreeupdate verifiers
  - update `TreeTest` to simulate incremental quaternary tree
  - update tests
- check for compensation in `invariant_protocol_walletBalanceEqualsCompletedDepositSumMinusTransferedOutPlusBundlerPayoutErc20` and add new test case for checking bundler balance equals tracked
- add bundler compensation to `OperationGenerator.sol`
- add unit test for `AssetUtils` encode and decode after bug fix
- fix `AssetUtils` bit shift bug where `encodedAssetAddr` was being incorrectly formatted and causing high asset values to produce wrong decodings
- add comment documenting retrieve deposit griefing assumption
- add invariant RE bottom log2(batch_size) bits of `OffchainMerkle.count`
- require `OffchainMerkle.insertNoteCommitments` ncs < scalar field
- require `CTM.fillBatchWithZeros` to be called on non-empty batch
- add initial CTM invariant tests
- add `CommitmentTreeManagerHandler`
- add `TestCommitmentTreeManager` to test harnesses
- Rename `BinaryMerkle` to just `IncrementalTree` + `LibIncrementalTree`
- Add invariant tests for tracking swap token balances
- Add erc20 transfers out to net balances invariant test
- Add `WalletHandler` to track bundle-related info
- Add `OperationGenerator` contract for creating random swaps and transfers
- Add `TokenIdSet` helper to invariant tests
- Add `exists` method `SimpleERC721Token`
- Split up invariant checks again to make debugging failures easier
- add `ProtocolInvariants.t.sol`, which inherits `InvariantsBase` and groups up related assertions into single invariants (more efficient use of test runs to check all assertions on every run)
- convert `DepositManagerInvariants.invariants.t.sol` into `InvariantsBase.sol` which only exports assertions and summary printing and itself does not run tests
- move state and instantiation logic out of `DepositManagerHandler` into the actual invariant test files
- rename `handlers` folder to `actors`
- rename `OffchainMerkleInvariants.invariants.t.sol` to just `OffchainMerkleInvariants.t.sol`
- add invariant tests for offchain merkle lib
- remove unused types in `Types.sol`
- move external methods to top in wallet / balance manager
- Change `InsertNotes` event to `InsertNote` (singular)
- Remove `insertNotes` (plural) and `insertNoteCommitment` (singular) + related events since both are dead code
- include `op.atomicActions` in op digest calculation
- make `handleOperation` default revert reason more helpful
- give different revert message if action reverts silently than if `handleOption` reverts
- Add 2 PIs for encrypted sender canonical address (`encSenderCanonAddrC1X`, `encSenderCanonAddrC2X`) to joinsplit verification logic
- add encrypted sender canonical address to `JoinSplit` struct
- Remove unused fns in `Queue.sol`
- Simplify `AssetUtils` to not have pass through fns
- Simplify `Utils` to only contain min function and SNARK_SCALAR_FIELD (no longer an "everything" utils file)
- Move tree-related utils in `Utils.sol` into `TreeUtils.sol`
- Encapsulate `Groth16.Proof` struct to Groth16 library so we don't have `Utils.proof8ToStruct` floating around everywhere
- underscore library methods that are only used internally within library currently
- resolve compiler build warnings coming from test code
- Add unit test for calling non allowed protocol
- Add `callableContractAllowlist` to handler which specifies which protocols + fn selectors users can call from handler
- remove all subtree batch fill refs from wallet
- make invariant tests exclude invariant handler from sender set
- start invariant tests, beginning with DepositManager tests
  - add `InvariantHandler.sol` for protocol-wide actor interface
  - Add helpers for tracking actors, balances, deposits
  - Add partially complete `DepositManager.invariants.t.sol`
- move all unit tests to `test/unit`
- add `EventParsing` test library that currently reads Deposit events into `DepositRequest`
- make `ParseUtils` library instead of contract
- fix deposit screener gas comp to account for cost of eth transfers
- fix bug in `DepositManager.completeDeposit` where deposit hashes were not being marked false post completion
- add support for instantiating ETH deposits + test case for success and failure
- Add test case for atomic actions + action failure
- Add `op.atomicActions` flag and revert in `handler.executeActions` if flag set to true and any action fails
- Add `opResults.assetsUnwrapped` flag to differentiate when joinsplits are processed or not
- Properly bubble up correct info in `OperationResult` between Wallet and Handler
- Reduce number of local stack vars used in `OperationUtils.computeOperationDigest`
- Delete unused `OperationUtils.unsuccessfulOperation` method
- Integrate `SafeERC20` into `AssetUtils`
  - NOTE: we are still waiting for next release from OZ to use `forceApprove` which is more gas efficient version of setting allowance to 0 then approving
- Generalize `JoinSplitsFailureType` in testing to `OperationFailureType` and add `BAD_CHAIN_ID` and `EXPIRED_DEADLINE` variants
- Add `chainId` and `deadline` to operation
- Re-order packing in `computeOperationDigest` and break into helper fns for stack size limit
- Simplify `DepositManager.instantiateDeposit` to only take asset, value, and depositAddr (convert deposit req checks into contract reads)
- Remove `chainId` from `DepositRequest` (already included in eip712 domain)
- Move `BinaryMerkle` into `test/utils`
- Move all poseidon and hasher references into `test/utils` (IHasher, IPoseidon, PoseidonHashers all go into tests because not used in production code)
- Add `Pausable` to wallet and handler + deps (balance manager & commitment tree)
  - Wallet: all non-admin external methods `whenNotPaused` (`depositFunds`, `processBundle`, `requestAsset`)
  - Handler: all non-admin external methods `whenNotPaused` (`handleDeposit`, `handleOperation`, `executeActions`)
    - BalanceManager: all onReceived hooks `whenNotPaused`
    - CommitmentTreeManager: `applySubtreeUpdate` made `whenNotPaused`
- `BalanceManager` revokes prefills for erc721s and enables for 1155s
- Rename `OperationReentrancyGuard` to `NocturneReentrancyGuard` and add `addAssetToPrefillGuard` to account for erc1155 prefills
- Add missing handler unit tests for setting subtree filler and adding to asset prefill
- Add missing wallet unit tests for bundler comp success and direct handler reentrancy into wallet
- Add balance manager token balance gas optimization, which allows for prefilling balances so we're not clearing token balance storage slots to 0 each time
- Have `TestBalanceManager` implement `IHandler` for ease of unit testing with wallet
- Rename `WalletUtils` `OperationUtils` now that both Wallet and Handler use it
- Separate `Wallet` functionality into `Wallet` (proof verification, entrypoint) and `Handler` (processing/executing operations, commitment tree)
- Remove vault contract entirely
- Fix bug where balance manager initialize was `public` not `internal`
- Add permission gate to `fillBatchWithZeros`
- Add fixture check against deposit request hash in `DepositManagerBase` unit tests
- Rename `processDeposit` and `DepositProcessed` to `completeDeposit` and `DepositCompleted`
- delegate to single verifier in batch verifier if batch size is 1
- Change Deposit events to include all info needed to recover deposit hash
- Refactor unit tests to whitelist deposit source for deposits now that we use that instead of `msg.sender == deposit.spender`
- Vault and BalanceManager now take both deposit and its `source` so they know where transfer funds from upon deposit
- Add `_depositSources` to wallet and integrate `DepositManager`
- Add `DepositManager` contract + unit tests up to process deposit failing because Wallet expects `msg.sender == deposit.spender` (to fix in followup PR)
- Bump Open Zeppelin npm deps to `4.8.2`
- Add json decoding utils for retrieving signed deposit request fixture
- Add initial `DepositManagerBase` contract and fixture unit test
- Add `Operation.gasAsset` instead of using `joinsplits[0]`
- Make `OperationReentrancyGuard` only for op processing/execution, use OZ `ReentrancyGuardUpgradable` for `processBundle` (the only actually exposed method for wallet)
- Add `Wallet` unit tests
  - Reentrancy from actions
  - In-action failure cases (call failure)
  - Pre-action failure cases (while processing joinsplits, not enough bundler comp)
  - Access control for `processOperation` and `executeActions`
  - OOG gas test
  - E2E tests with receiving assets from `TokenSwapper` test contract
- Add more `BalanceManager` tests for testing joinsplit verification failures
- Add `ForgeUtils` contract for vm expecting events
- Add `TokenSwapper` and `ReentrantCaller` test contracts for wallet tests
- Add interfaces for Simple tokens to be used in `TokenSwapper`
- Remove `verificationGasLimit` from `Operation`
- Break shared utils for Wallet and BalanceManager into `NocturneUtils` test lib
- Add separate `BalanceManager` unit tests (`BalanceManager.t.sol`)
- Move designated test contracts into `test/harnesses` folder
- Granularize in-contract gas estimate by separating joinsplit cost into verification + handling in `Types.sol`
- Add script for producing `.storage-layouts` file + commit `.storage-layouts` file
- Add storage GAP to `NocturneReentrancyGuard`
- Remove `poseidonTest` from `Wallet.t.sol`
- Delete old `gasTesting` files
- Move the Simple ERC tokens to `test`
- Rename `libs/types.sol` to uppercase `Types.sol`
- Rename:
  - `NoteTransmission` -> `EncryptedNote`
  - `NocturneAddress` -> `StealthAddress`
  - `JoinSplit` event -> `JoinSplitProcessed` event
  - `Refund` event -> `RefundProcessed` event
  - `JoinSplitTx` -> `JoinSplit`
- Remove `deployer` directory in favor of `deploy` package
- Deploy script takes mock subtree update verifier param as env var
- Deploy script logs network info and start block
- Check if bundler payout > 0 tokens and only call transfer if so
- fix loop index bug in `extractJoinSplitProofsAndPis`
- fix contract calculating opDigest differently from frontend
- put forge deps install script into this package
- Add additional unit tests for processing multiple joinsplits
- Make underscores consistent in `WalletUtils` and `AssetUtils`
- Optimizer runs 99999 -> 500 to get back under code size limit
- Modify `hardhat.config.ts` to take private keys from env for deploy script
- Add deploy script to `deployer` directory
- Replace all dependent OZ libraries with their upgradeable versions for Wallet, BalanceManager, CommitmentTreeManager, and NocturneReetrancyGuard
- Replace all constructors for initializers (in Wallet, BalanceManager, CommitmentTreeManager, and NocturneReentrancyGuard)
- Add TransparentProxy, ProxyAdmin, and Versioned to `contracts/upgrade`
- Changed to a custom implementation of ReentrancyGuard to properly reflect operation processing status
- Fixed a bug that `_receivedAssets` is modified outside an operation
- Fixed a bug that refunds in `encodedRefundAssets` are not processed
- Merge `joinSplitTx.encodedAssetAddr` and `joinSplitTx.encodedAssetId` into one `joinSplitTx.encodedAsset`
- Make `performOperation` nonReentrant
- Remove unnecessary `_nonce` state variable, use current tree size as nonce
- Remove `opSuccess` and add `opProcessed`, which indicate internal error during processing
- Fix asset/id encoding according to design doc
- Overhaul BalanceManager logic to use less storage
- Implement gas fee mechanism
- add test for subtree update PI calculation
- separate subtree update PI calculation into separate function
- Make solidity var underscore style consistent
- Add `ProcessOperation` event to wallet to emit details about processed ops
- `Wallet._makeExternalCall` no longer reverts on reverting contract call (enables us to process calls even if they revert)
- Calculate `operationDigest` in wallet instead of pushing `uint256` conversion and mod to `CommitmentTreeManager`
- Use the batch verifier to batch verify all joinsplit proofs in a bundle
- Change verifier interfaces to take structs instead of `uint256` arrays
- Add a `SubtreeUpdate` event to `CommitmentTreeManager` for when a subtree update is committed
- Add `test:gas-report` command
- Add batch proof verification
- Add a `SubtreeUpdate` event to `CommitmentTreeManager` for when a subtree update is committed
- Add `test:gas-report` command
- Migrate for joinsplit
  - Compute operationDigest once for the entire operation
- Rename all "flax" instances to "nocturne"
- Change package version to `-alpha`
- Rename `Joinsplit` to `JoinSplit`
- move `OffchainMerkleTree` into a library and have `CommitmentTreeManager` hold the state
- remove `IBatchMerkle` and `BatchBinaryMerkle`
- split `Utils` into `TreeUtils` and `Utils`
- Add fixture unit test for `SubtreeUpdateVerifier`
- Update `DummyWallet` unit test to use `OffchainMerkleTree` instead
- Add unit test for `OffchainMerkleTree`
- Add `TreeTest` lib to test utils. Containins helpers for computing / maintaining subtree roots
- Add `TestSubtreeUpdateVerifier` to test utils
- Change `CommitmentTreeManager` to use `OffchainMerkleTree` instead of `BatchBinaryMerkle`
- Remove Poseidon from all contracts
- Split `LeavesInserted` event into `InsertNoteCommitment` and `InsertNote`
- Add `IOffChainMerkleTree` and `MerkleTree` for Offchain ZK updates
- Add `Utils` lib for encoding / hashing details
- Add `SubtreeUpdateVerifier` contract
- Make Pairing library from circom reusable for different circuits
- Fix events to have fields > 32 bytes be not `indexed`
- Add `Spend` event and emit on `handleSpend`
- Rename spend transaction `value` to `valueToSpend`
- Fix merkle index bug where `insert8` and `insert16` only incremented `numberOfLeaves` by 1
- Start test suite for `PoseidonBatchBinaryMerkle`
- Break up `BatchBinaryMerkle` lib into `BinaryMerkle` and `Queue`
- Add `Refund` events to `CommitmentTreeManager`
- Update `Spend2Verifier` to match simplified `NocturneAddress` + vk/sk scheme
- Rename `SpendTransaction.noteCommitment` to `newNoteCommitment` for clarity
- Add tests for verifier contract
- Make commitment tree and hash functions generic behind interfaces
- Add contracts as package in yarn workspace
