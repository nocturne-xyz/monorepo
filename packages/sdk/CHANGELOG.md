# Changelog

### Unreleased

- add more tests for new `NotesDB` impl
- fix db tests
- make `NotesManager` use `removeNotesByNullifiers` instead of looping through the entire DB
- re-implement `NotesDB` to index notes by `merkleIndex`, `nullifier`, and `asset`. 
- rename `getNotesFor` -> `getNotesForAsset`
- make `OpPreparer` and `NotesManager` use `NocturneViewer` instead of `NocturneSigner`
- move  `crypto`, `proof`, `note`, `asset`, and `binaryPoseidonTree`, and `commonTypes` to new package `@nocturne-xyz/primitives`
- move `utils` module to its own package
- move `ethers` utils into `indexing` module
- create `OpSimulator`
- move `signOperation` to a new class `OpSigner`
- replace `proveOperation` with `OpProver`
- replace `prepareOperation` with `OpPreparer` 
- Remove `verificationGasLimit` from `Operation`
- clean module hierarchy:
  - flatten `sdk` submodule
  - remove unnecessary exports
  - make exports explicit
  - clean up imports so that they don't depend on internal structure of other modules
- merge `NocturnePrivKey` and `NocturneSigner`
- replace `circomlibjs` and `ffjavascript` with `@nocturne-xyz/circuit-utils`
- replace `NocturneContext.test.ts` with unit tests for each of the newly-split-out parts
- disembowel `NocturneContext`, reducing it to a convencience wrapper for all private state
- add new module / function `proveOperation` that separates the proving logic form `NocturneContext`
- add method `signOperation` to `NocturneSigner`
- rename `PreProofOperation` to `SignedOperation`
- add new module / function `prepareOperation` that separates `tryGetPreProofOperation` from `NocturneContext`
- add `OperationRequestBuilder`
- move `Asset` and related types / functions to new module `asset`
- Rename:
  - `NoteTransmission` -> `EncryptedNote`
  - `NocturneAddress` -> `StealthAddress`
  - `LocalNotesManager` -> `DefaultNotesManager`
  - `LocalMerkleProver` -> `InMemoryMerkleProver`
  - `LocalJoinSplitProver` -> `WasmJoinSplitProver`
  - `LocalSubtreeUpdateProver` -> `WasmSubtreeUpdateProver`
  - `JoinSplitTx` -> `JoinSplit`
  - `calculateOperationDigest` -> `computeOperationDigest`
- Fix bug where joinsplits being processed in tandem with refunds was causing some refund notes to not be removed by joinsplits
- Fix bug where zeroed dummy notes always produce same NF by generating rand address and nonce
- `LocalMerkleProver` and `LocalNotesManager` take optional start blocks as params
- Fix unawaited promise when calling `processNoteTransmission` on handling new joinsplits
- move `OperationStatus` to `commonTypes` from `@nocturne-xyz/bundler`
- remove nested hash for refund assets in `calculateOperationDigest`
- factor `proveJoiNSplitTx` into a separate function
- add function `JoinSplitPublicSignalsToArray`
- add function `unpackFromSolidityProof` to convert `SolidityProof -> BaseProof`
- factor contents of `NocturneContext.proveJoinSplitTx` into a standalone helper
- Add `makeProvenJoinSplitTx` util function that removes additional fields `PreProofJoinSplitTx` has
- Fix `NocturneContext.gatherMinimumNotes` bug by adding missing await for `this.ensureMinimumForAssetRequest` and updating test
- Depend on nocturne fork of circomlibjs
- Fix `decodeAsset` not padding out address with zeros
- Change `NocturneContext` constructor to take wallet address and provider instead of `Wallet` object
- Use `randombytes` instead of node `crypto`
- Use patched fork of `circomlibjs`
- Avoid usage of `Buffer` in `sdk`.
- Merge `joinSplitTx.encodedAssetAddr` and `joinSplitTx.encodedAssetId` into one field `joinSplitTx.encodedAsset`
- Add utility function to estimate `executionGasLimit` and `maxNumRefund`
- Change note commitment to use encoded `asset` and `ID`
- Add and `encode` and `decode` methods to `NoteTrait`
- Change `NoteInput` to `EncodedNote`
- Refactor DB interfaces
  - separate underlying `KVStore` from "DB"s by defining `KVStore` abstract class
  - implement `KVStore` with a new class `InMemoryKVStore` using a B+ Tree lib
  - split `NocturneDB` into `NotesDB` and `MerkleDB`
  - add tests
  - integrate new DB interfaces into `LocalMerkleProver`, `LocalNotesManager`, and `NocturneContext`
- Add util method for parsing events from tx receipt and break utils into `bits.ts` and `ethers.ts`
- Bug fix, `packToSolidityProof` casts numbers to bigints
- Update `gatherMinimumNotes` logic to actually gather minimum number of notes
- Add interfaces for generating and receiving confidential payments
- Remove `toJSON` and all `fromJSON` methods in favor of custom `bigint-json-serialization`
- Add query function for `SubtreeUpdate` events
- Pull out note / tree insertion fetching logic into `indexing` module
- Add `indexing` module for code that fetches data from chain
- Add interfaces for subtree update prover
- Remove unnessary normalization of circuit values
- Add context methods for ensuring min asset balance and reading all balances
- Proving no longer takes files as function args (moved to local-prover class instantiation)
- Migrate to joinsplit circuit
  - Nocturne context refractoe: Presign -> PreProof -> Proven
  - Note encryption and decryption
  - New note fetching logic
- Rename all "flax" instances to "nocturne"
- Change package version to `-alpha`
- Break out SDK methods into sub methods and expose a method for gathering spend tx inputs for site/snap to use
- Replace `LMDB` with `ObjectDB`, which fits structure of MM snap schema
- Take out all fs and proving related capabilities from SDK and replace with blank interfaces (turn SDK into shim)
- Rename `PostProof` to `Proven` among data types
- add `update` method to `BinaryPoseidonTree`
- use `bigint-conversion` for bigint packing stuff
- Update merkle prover indexing logic to work with off-chain updates
- add script to generate input signals for `subtreeupdate` circuit
- Fix indexing bug when only querying a single block
- Add scripts to generate test cases for joinsplit circuit
- Add `sdk` directory to include `db`, `merkleProver`, `notesManager` and wrap up that functionality in `NocturneContext`
- Add `NocturneLMDB` as local SDK `NocturneDB`
- Add `LocalNotesManager` as local SDK `NotesManager`
- Add `LocalMerkleProver` as local SDK `MerkleProver`
- Have all packages follow `index.ts` --> `export *` structure
- Rename spend transaction `value` to `valueToSpend`
- Add `NocturneContext` object and add functionality for converting an asset request and desired operation to a `PostProofOperation` containing potentially several spend txs
- Update `generateSpend2TestCase` script to write to `/fixtures`
- Update `NocturneSigner` to derive `vk` from `sk` and use simplified 2 field `NocturneAddress`
- Move spend2 circuit prove/verify methods into sdk
- Add babyjub classes and poseidon tree
